{
  "openapi": "3.0.3",
  "info": {
    "title": "图书管理系统 API",
    "description": "基于Flask的图书管理系统RESTful API接口文档",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:5000",
      "description": "开发服务器"
    }
  ],
  "tags": [
    {"name": "认证", "description": "用户认证相关接口"},
    {"name": "图书", "description": "图书管理相关接口"},
    {"name": "借阅", "description": "借阅管理相关接口"},
    {"name": "用户", "description": "用户管理相关接口"}
  ],
  "paths": {
    "/api/auth/login": {
      "post": {
        "tags": ["认证"],
        "summary": "用户登录",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["username", "password"],
                "properties": {
                  "username": {"type": "string", "example": "admin"},
                  "password": {"type": "string", "example": "admin123"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "登录成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "message": {"type": "string"},
                    "user": {"$ref": "#/components/schemas/User"}
                  }
                }
              }
            }
          },
          "401": {"description": "用户名或密码错误"}
        }
      }
    },
    "/api/auth/logout": {
      "post": {
        "tags": ["认证"],
        "summary": "用户登出",
        "security": [{"cookieAuth": []}],
        "responses": {
          "200": {"description": "登出成功"}
        }
      }
    },
    "/api/auth/register": {
      "post": {
        "tags": ["认证"],
        "summary": "用户注册",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["username", "password", "name"],
                "properties": {
                  "username": {"type": "string"},
                  "password": {"type": "string"},
                  "name": {"type": "string"},
                  "phone": {"type": "string"}
                }
              }
            }
          }
        },
        "responses": {
          "201": {"description": "注册成功"},
          "400": {"description": "参数错误或用户名已存在"}
        }
      }
    },
    "/api/auth/me": {
      "get": {
        "tags": ["认证"],
        "summary": "获取当前用户信息",
        "security": [{"cookieAuth": []}],
        "responses": {
          "200": {
            "description": "成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "user": {"$ref": "#/components/schemas/User"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/auth/change-password": {
      "post": {
        "tags": ["认证"],
        "summary": "修改密码",
        "security": [{"cookieAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["old_password", "new_password"],
                "properties": {
                  "old_password": {"type": "string"},
                  "new_password": {"type": "string"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {"description": "修改成功"},
          "400": {"description": "旧密码错误"}
        }
      }
    },
    "/api/books": {
      "get": {
        "tags": ["图书"],
        "summary": "获取图书列表",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 10}}
        ],
        "responses": {
          "200": {
            "description": "成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "books": {"type": "array", "items": {"$ref": "#/components/schemas/Book"}},
                    "total": {"type": "integer"},
                    "pages": {"type": "integer"},
                    "current_page": {"type": "integer"}
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["图书"],
        "summary": "新增图书（管理员）",
        "security": [{"cookieAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["title", "author", "isbn"],
                "properties": {
                  "title": {"type": "string"},
                  "author": {"type": "string"},
                  "isbn": {"type": "string"},
                  "quantity": {"type": "integer", "default": 1}
                }
              }
            }
          }
        },
        "responses": {
          "201": {"description": "添加成功"},
          "400": {"description": "参数错误或ISBN已存在"},
          "403": {"description": "需要管理员权限"}
        }
      }
    },
    "/api/books/{book_id}": {
      "get": {
        "tags": ["图书"],
        "summary": "获取图书详情",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "book_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "404": {"description": "图书不存在"}
        }
      },
      "put": {
        "tags": ["图书"],
        "summary": "修改图书（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "book_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "title": {"type": "string"},
                  "author": {"type": "string"},
                  "isbn": {"type": "string"},
                  "quantity": {"type": "integer"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {"description": "更新成功"},
          "403": {"description": "需要管理员权限"},
          "404": {"description": "图书不存在"}
        }
      },
      "delete": {
        "tags": ["图书"],
        "summary": "删除图书（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "book_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "responses": {
          "200": {"description": "删除成功"},
          "400": {"description": "有未归还借阅"},
          "403": {"description": "需要管理员权限"},
          "404": {"description": "图书不存在"}
        }
      }
    },
    "/api/books/search": {
      "get": {
        "tags": ["图书"],
        "summary": "搜索图书",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "keyword", "in": "query", "schema": {"type": "string"}},
          {"name": "type", "in": "query", "schema": {"type": "string", "enum": ["all", "title", "author", "isbn"]}},
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 10}}
        ],
        "responses": {
          "200": {"description": "搜索成功"}
        }
      }
    },
    "/api/borrows": {
      "get": {
        "tags": ["借阅"],
        "summary": "获取借阅记录列表",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 10}},
          {"name": "status", "in": "query", "schema": {"type": "string", "enum": ["borrowed", "returned", ""]}}
        ],
        "responses": {
          "200": {
            "description": "成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "records": {"type": "array", "items": {"$ref": "#/components/schemas/BorrowRecord"}},
                    "total": {"type": "integer"},
                    "pages": {"type": "integer"},
                    "current_page": {"type": "integer"}
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["借阅"],
        "summary": "办理借阅（管理员）",
        "security": [{"cookieAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["user_id", "book_id"],
                "properties": {
                  "user_id": {"type": "integer"},
                  "book_id": {"type": "integer"},
                  "days": {"type": "integer", "default": 30}
                }
              }
            }
          }
        },
        "responses": {
          "201": {"description": "借阅成功"},
          "400": {"description": "参数错误或无库存"},
          "403": {"description": "需要管理员权限"},
          "404": {"description": "用户或图书不存在"}
        }
      }
    },
    "/api/borrows/{record_id}": {
      "get": {
        "tags": ["借阅"],
        "summary": "获取借阅记录详情",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "record_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "403": {"description": "无权查看"},
          "404": {"description": "记录不存在"}
        }
      }
    },
    "/api/borrows/{record_id}/return": {
      "put": {
        "tags": ["借阅"],
        "summary": "办理归还（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "record_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "responses": {
          "200": {"description": "归还成功"},
          "400": {"description": "已归还"},
          "403": {"description": "需要管理员权限"},
          "404": {"description": "记录不存在"}
        }
      }
    },
    "/api/borrows/user/{user_id}": {
      "get": {
        "tags": ["借阅"],
        "summary": "查询用户借阅记录",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "user_id", "in": "path", "required": true, "schema": {"type": "integer"}},
          {"name": "status", "in": "query", "schema": {"type": "string", "enum": ["borrowed", "returned", ""]}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "403": {"description": "无权查看"}
        }
      }
    },
    "/api/borrows/book/{book_id}": {
      "get": {
        "tags": ["借阅"],
        "summary": "查询图书借阅记录（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "book_id", "in": "path", "required": true, "schema": {"type": "integer"}},
          {"name": "status", "in": "query", "schema": {"type": "string", "enum": ["borrowed", "returned", ""]}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "403": {"description": "需要管理员权限"}
        }
      }
    },
    "/api/borrows/overdue": {
      "get": {
        "tags": ["借阅"],
        "summary": "获取逾期借阅记录（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 10}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "403": {"description": "需要管理员权限"}
        }
      }
    },
    "/api/users": {
      "get": {
        "tags": ["用户"],
        "summary": "获取用户列表（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 10}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "403": {"description": "需要管理员权限"}
        }
      },
      "post": {
        "tags": ["用户"],
        "summary": "新增用户（管理员）",
        "security": [{"cookieAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["username", "password", "name"],
                "properties": {
                  "username": {"type": "string"},
                  "password": {"type": "string"},
                  "name": {"type": "string"},
                  "phone": {"type": "string"},
                  "role": {"type": "string", "enum": ["admin", "user"], "default": "user"}
                }
              }
            }
          }
        },
        "responses": {
          "201": {"description": "创建成功"},
          "400": {"description": "参数错误或用户名已存在"},
          "403": {"description": "需要管理员权限"}
        }
      }
    },
    "/api/users/{user_id}": {
      "get": {
        "tags": ["用户"],
        "summary": "获取用户详情",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "user_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "responses": {
          "200": {"description": "成功"},
          "403": {"description": "无权查看"},
          "404": {"description": "用户不存在"}
        }
      },
      "put": {
        "tags": ["用户"],
        "summary": "修改用户",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "user_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "username": {"type": "string"},
                  "name": {"type": "string"},
                  "phone": {"type": "string"},
                  "role": {"type": "string", "enum": ["admin", "user"]},
                  "password": {"type": "string"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {"description": "更新成功"},
          "403": {"description": "无权修改"},
          "404": {"description": "用户不存在"}
        }
      },
      "delete": {
        "tags": ["用户"],
        "summary": "删除用户（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "user_id", "in": "path", "required": true, "schema": {"type": "integer"}}
        ],
        "responses": {
          "200": {"description": "删除成功"},
          "400": {"description": "有未归还借阅或不能删除自己"},
          "403": {"description": "需要管理员权限"},
          "404": {"description": "用户不存在"}
        }
      }
    },
    "/api/users/search": {
      "get": {
        "tags": ["用户"],
        "summary": "搜索用户（管理员）",
        "security": [{"cookieAuth": []}],
        "parameters": [
          {"name": "keyword", "in": "query", "schema": {"type": "string"}},
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 10}}
        ],
        "responses": {
          "200": {"description": "搜索成功"},
          "403": {"description": "需要管理员权限"}
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "cookieAuth": {
        "type": "apiKey",
        "in": "cookie",
        "name": "session"
      }
    },
    "schemas": {
      "User": {
        "type": "object",
        "properties": {
          "id": {"type": "integer", "example": 1},
          "username": {"type": "string", "example": "admin"},
          "name": {"type": "string", "example": "管理员"},
          "phone": {"type": "string", "example": "10000000000"},
          "role": {"type": "string", "enum": ["admin", "user"], "example": "admin"},
          "created_at": {"type": "string", "format": "date-time"}
        }
      },
      "Book": {
        "type": "object",
        "properties": {
          "id": {"type": "integer", "example": 1},
          "title": {"type": "string", "example": "Python编程从入门到实践"},
          "author": {"type": "string", "example": "Eric Matthes"},
          "isbn": {"type": "string", "example": "9787115428028"},
          "quantity": {"type": "integer", "example": 5},
          "available": {"type": "integer", "example": 3},
          "is_available": {"type": "boolean", "example": true},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        }
      },
      "BorrowRecord": {
        "type": "object",
        "properties": {
          "id": {"type": "integer", "example": 1},
          "user_id": {"type": "integer", "example": 1},
          "book_id": {"type": "integer", "example": 1},
          "user": {"$ref": "#/components/schemas/User"},
          "book": {"$ref": "#/components/schemas/Book"},
          "borrow_date": {"type": "string", "format": "date-time"},
          "due_date": {"type": "string", "format": "date-time"},
          "return_date": {"type": "string", "format": "date-time", "nullable": true},
          "status": {"type": "string", "enum": ["borrowed", "returned"]},
          "is_overdue": {"type": "boolean"}
        }
      },
      "Error": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean", "example": false},
          "message": {"type": "string", "example": "请求参数错误"}
        }
      }
    }
  }
}